<!DOCTYPE html>
<html>
<head>
  <title>math.js | plot</title>
  <script src="https://unpkg.com/mathjs@4.1.1/dist/math.min.js"></script>

  <!-- Load d3.js -->
  <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
  <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
  
  <!-- CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="public/famous.css" />

  <!-- D3 CSS -->
  <style>
      /* tell the SVG path to be a blue line without any area fill */
      path {
        stroke: steelblue;
        fill: none;
      }
      
      .axis {
        shape-rendering: crispEdges;
      }
      .x.axis line {
        stroke: lightgrey;
      }
      .x.axis .minor {
        stroke-opacity: .5;
      }
      .x.axis path {
        display: none;
      }
      .y.axis line, .y.axis path {
        fill: none;
        stroke: #000;
      }
    </style>

</head>
<body>

  <form id="form">
    <label for="eq">Enter an equation:</label>
    <input type="text" id="eq" value="4 * sin(x) + 5 * cos(x/2)" />
    <input type="submit" value="Draw" />
  </form>
  <div id="plot"><svg width="1500" height="600"></svg></div>
  <div id="hoverInfo" style="margin-left:80px;">Not hovering...</div>

  <p>
    Used plot library: <a href="https://d3js.org/">D3.js</a>
  </p>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
  <script>
    var socket = io();
    var chart;
    function make() {

      d3.selectAll("svg > *").remove(); // Clear the graph before drawing a new one

      // Move the plot a bit away from the margins
      var svg = d3.select("svg"),
          margin = {top: 20, right: 20, bottom: 30, left: 50},
          width = +svg.attr("width") - margin.left - margin.right,
          height = +svg.attr("height") - margin.top - margin.bottom,
          g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      var x = d3.scaleLinear()
          .rangeRound([0, width]);

      var y = d3.scaleLinear()
          .rangeRound([height, 0]);

      // compile the expression once
      var expression = document.getElementById('eq').value;
      var expr = math.compile(expression);

      // evaluate the expression repeatedly for different values of x
      var xValues = math.range(-10, 10, 0.1).toArray();
      var yValues = xValues.map(function (x) {
        return expr.eval({x: x}); 
      });

      var data = []
      xValues.forEach(function(val, i) {
        data.push({'x': val, 'y': yValues[i]})
      });

      var line = d3.line()
                   .curve(d3.curveLinear)
                   .x(function(d) { return x(d.x); })
                   .y(function(d) { return y(d.y); });

      x.domain(d3.extent(data, function(d) { return d.x; }));
      y.domain(d3.extent(data, function(d) { return d.y; }));

      // Draw the x axis and move to the center
      g.append("g")
          .attr("transform", "translate(0," + height/2 + ")")
          .call(d3.axisBottom(x))

      // Draw the y axis and move to the center
      g.append("g")
          .attr("transform", "translate(" + width/2 +",0)")
          .call(d3.axisLeft(y))
          .attr("y", 6)
          .attr("dy", "0.71em")

      // Draw the actual points  
      g.append("path")
          .datum(data)
          .attr("fill", "none") // Path is closed automatically so hide filling
          .attr("stroke", "steelblue")
          .attr("stroke-linejoin", "round")
          .attr("stroke-linecap", "round")
          .attr("stroke-width", 15) // Wider stroke means more area to interact with
          .attr("d", d3.line()
                     .curve(d3.curveLinear)
                     .x(function(d) { return x(d.x); })
                     .y(function(d) { return y(d.y); })
          ).attr("pointer-events", "stroke") // visiblePainted, visibleStroke, painted
          .on('mouseenter', function() { // Should match event fired by LeapCursor.js
            console.log('mouse');
            hoverInfo.innerHTML = 'Hovering!';
            socket.emit('line hover', {data: ''});
          })
          .on('mouseleave', function() { // Should match event fired by LeapCursor.js
            console.log('left');
            hoverInfo.innerHTML = 'Not hovering...';
            socket.emit('line unhover', {data: ''});
          }); 
    }
    document.getElementById('form').onsubmit = function (event) {
        event.preventDefault();
        make(); // Redraw chart when we get a new function input
      };
    make();
  </script>

  <!-- For LeapCursor, with dependencies -->
  <script type="text/javascript" src="public/leap.min.js"></script>
  <script type="text/javascript" src="public/leap-plugins.min.js"></script>
  <script type="text/javascript" src="public/three.min.js"></script>
  <script type="text/javascript" src="public/Detector.js"></script>
  <script type="text/javascript" src="public/LeapCursor.js"></script>
</body>
</html>