<!DOCTYPE html>
<html>
<head>
  <title>math.js | plot</title>
  <script src="https://unpkg.com/mathjs@4.1.1/dist/math.min.js"></script>

  <!-- Load d3.js -->
  <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
  <script src="https://unpkg.com/d3@3/d3.min.js"></script>
  <script src="https://unpkg.com/function-plot@1/dist/function-plot.js"></script>
  
  <!-- CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="public/famous.css" />

  <!-- D3 CSS -->
  <style>
      /* tell the SVG path to be a blue line without any area fill */
      path {
        stroke: steelblue;
        fill: none;
      }
      
      .axis {
        shape-rendering: crispEdges;
      }
      .x.axis line {
        stroke: lightgrey;
      }
      .x.axis .minor {
        stroke-opacity: .5;
      }
      .x.axis path {
        display: none;
      }
      .y.axis line, .y.axis path {
        fill: none;
        stroke: #000;
      }

      form {
        padding-left: 20px;
      }

      h1 {
        text-align: center;
      }
    </style>

</head>
<body>
  <!-- <h1>Mathemagica</h1> -->
  <form id="form">
    <label for="eq">Enter an equation:</label>
    <input type="text" id="eq" value="4*sin(x) + 5*cos(x/2)" />
    <input type="submit" value="Draw" />
  </form>
  <div id="plot"><svg width="1500" height="600"></svg></div>
  <div id="hoverInfo" style="margin-left:80px;">Not hovering...</div>

  <p>
    Used plot library: <a href="https://mauriciopoppe.github.io/function-plot/">function-plot.js</a>
  </p>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
  <script>
    var socket = io();
    var chart;
    var p;
    const CLIP_Y_OFFSET = 9; // To hide the lines at the top of the graph
    const CLIP_HEIGHT = 542; // To hide the lines at the bottom of the graph
    const VIB_THRESHOLD = 1;// num ticks, distance threshold past which to set PWM to 0
    var getPWM = function(canvasX, canvasY, yScale, expr) {
        // let offset = 0;//Math.abs(yScale.ticks()[2] - yScale.ticks()[0]);
        //let offset = $('.zoom-and-drag').offset(); // Get top and left offset for
        let actual_y = canvasY;// + offset;
        let expected_y = expr.eval({x: canvasX});
        let actual_diff = Math.abs(expected_y - actual_y);
        let threshold = Math.abs(yScale.ticks()[1] - yScale.ticks()[0]) * VIB_THRESHOLD; 
        let norm = 1 - Math.abs(actual_y - expected_y)/Math.abs(threshold - expected_y);
        // let norm = 1 - (Math.abs(actual_y - expected_y)/Math.abs(threshold - expected_y));
        // let pwm = -Math.log10(Math.min(1, Math.max(1-norm, 0)))*255;
        // console.log(pwm, norm, Math.max(norm, 0));
        let pwm = Math.max(norm * 255, 0);
        console.log(pwm, norm, canvasX, canvasY);
        return pwm;
    }

    function plot() {
      // compile the expression once
      var expression = document.getElementById('eq').value;
      var expr = math.compile(expression);
      // evaluate the expression repeatedly for different values of x
      var xValues = math.range(-10, 10, 0.1).toArray();
      var yValues = xValues.map(function (x) {
        return expr.eval({x: x}); 
      });
      var xMin = math.round(math.min(xValues));
      var xMax = math.round(math.max(xValues));
      var yMin = math.round(math.min(yValues));
      var yMax = math.round(math.max(yValues));
      const OFFSET = (yMax-yMin)/10; // to deal with the SVG mask
      var coords = [0,0];

      // For some reason, the y coordinates are offset by roughly two ticks, 
      // so we manually add 2-ticks-worths to the y coordinate

      p = functionPlot({
        target: '#plot',
        width: 1700,
        height: 600,
        xAxis: {
          domain: [xMin, xMax]
        },
        yAxis: {
          domain: [yMin-OFFSET, yMax+OFFSET]
          // domain: [yMin, yMax]
        },
        grid: true,
        data: [{
          fn: expression,
          graphType: 'polyline',
          attr: {
            'stroke-width': '20px'
          },
          skipTip: true,
        }]
      });
      var canvasX = p.meta.xScale.invert;
      var canvasY = p.meta.yScale.invert;

      var ticks = p.meta.yScale.ticks();
      var y_canvas_offset = Math.abs(ticks[2] - ticks[0]);

      // Configure the mask to not cover the edges of the graph
      d3.select('.clip')
        .attr('y', CLIP_Y_OFFSET)
        .attr('height', CLIP_HEIGHT);

      // Have hovers go through canvas to line
      d3.select('.zoom-and-drag').attr('style', 'fill: none; pointer-events:none');

      // Compute y distance to point on graph
      d3.select('.canvas').on('mousemove', function() {
//          var coords = d3.mouse(this);
//          let x = canvasX(coords[0]);
//          let y = canvasY(coords[1]);
//          console.log(x,y, math.abs(y - expr.eval({x: x})));
     //       console.log('whoops', d3.event);
        })
/*        .on('thumbenter', function(elm) {
            var coords = d3.event.detail.coords;

             // Get top and left offset for canvas
            let offset = $('.zoom-and-drag').offset();
            let x = canvasX(coords[1]-offset.left);
            let y = canvasY(coords[0]-offset.top);
            console.log("Coords:", coords, "offset", offset, "x:", x, "y:",y);
            let y_hat = expr.eval({x: x});
            let pwm = getPWM(x, y, p.meta.yScale, expr);
            socket.emit('thumb enter', pwm);
        }) */
        .on('indexenter', function(elm) {
            var coords = d3.event.detail.coords;
            let offset = $('.zoom-and-drag').offset();
            let x = canvasX(coords[1]-offset.left);
            let y = canvasY(coords[0]-offset.top);
            let y_hat = expr.eval({x: x});
            let pwm = getPWM(x, y, p.meta.yScale, expr);
            socket.emit('index enter', pwm);
            console.log('indexpwm', pwm)
        }) 
        .on('middleenter', function(elm) {
            var coords = d3.event.detail.coords;
            let offset = $('.zoom-and-drag').offset();
            let x = canvasX(coords[1]-offset.left);
            let y = canvasY(coords[0]-offset.top);
            let y_hat = expr.eval({x: x});
            let pwm = getPWM(x, y, p.meta.yScale, expr);
            socket.emit('middle enter', pwm);
        }) 
        .on('ringenter', function(elm) {
            var coords = d3.event.detail.coords;
            let offset = $('.zoom-and-drag').offset();
            let x = canvasX(coords[1]-offset.left);
            let y = canvasY(coords[0]-offset.top);
            let y_hat = expr.eval({x: x});
            let pwm = getPWM(x, y, p.meta.yScale, expr);
            socket.emit('ring enter', pwm);
        }) 
        .on('pinkyenter', function(elm) {
            var coords = d3.event.detail.coords;
            let offset = $('.zoom-and-drag').offset();
            let x = canvasX(coords[1]-offset.left);
            let y = canvasY(coords[0]-offset.top);
            let y_hat = expr.eval({x: x});
            let pwm = getPWM(x, y, p.meta.yScale, expr);
            socket.emit('pinky enter', pwm)
        }) 

      // Add event listeners to main line
      d3.select('.line')
        .attr("pointer-events", "stroke") // visiblePainted, visibleStroke, painted
        .on('mousemove', function() {
          //console.log(d3.mouse(this));
          //coords = d3.mouse(this);
          //console.log(coords);
        })
        /*  .on('mouseenter', function() { // Should match event fired by LeapCursor.js
            console.log('mouse');
            hoverInfo.innerHTML = 'Hovering!';
            //socket.emit('line hover', {data: ''});
          })
          .on('mouseleave', function() { // Should match event fired by LeapCursor.js
            console.log('left');
            hoverInfo.innerHTML = 'Not hovering...';
            //socket.emit('line unhover', {data: ''});
          })
          .on('thumbenter', function() {
            hoverInfo.innerHTML = 'Thumb';
            console.log('thumb entered');
            socket.emit('thumb enter');
          })
          .on('thumbleave', function() {
            hoverInfo.innerHTML = 'Not hovering...';
            console.log('thumb left');
            socket.emit('thumb leave');
          }) 
          .on('indexenter', function() {
            hoverInfo.innerHTML = 'Index';
            console.log('index entered');
            socket.emit('index enter');
          })
          .on('indexleave', function() {
            hoverInfo.innerHTML = 'Not hovering...';
            console.log('index left');
            socket.emit('index leave');
          })
          .on('middleenter', function() {
            hoverInfo.innerHTML = 'Middle';
            console.log('middle entered');
            socket.emit('middle enter');
          })
          .on('middleleave', function() {
            hoverInfo.innerHTML = 'Not hovering...';
            console.log('middle left');
            socket.emit('middle leave');
          }) 
          .on('ringenter', function() {
            hoverInfo.innerHTML = 'Ring';
            console.log('ring entered');
            socket.emit('ring enter');
          })
          .on('ringleave', function() {
            hoverInfo.innerHTML = 'Not hovering...';
            console.log('ring left');
            socket.emit('ring leave');
          })
          .on('pinkyenter', function() {
            hoverInfo.innerHTML = 'Pinky';
            console.log('pinky entered');
          })
          .on('pinkyleave', function() {
            hoverInfo.innerHTML = 'Not hovering...';
            console.log('pinky left');
          });*/;
    }
    document.getElementById('form').onsubmit = function (event) {
        event.preventDefault();
        plot();
      };
    plot();
    document.body.addEventListener('motorsoff', function() {
      console.log('motors are coming off');
      socket.emit('motorsoff');
    })
  </script>

  <!-- For LeapCursor, with dependencies -->
  <script type="text/javascript" src="public/leap.min.js"></script>
  <script type="text/javascript" src="public/leap-plugins.min.js"></script>
  <script type="text/javascript" src="public/three.min.js"></script>
  <script type="text/javascript" src="public/Detector.js"></script>
  <script type="text/javascript" src="public/LeapCursor.js"></script>
</body>
</html>